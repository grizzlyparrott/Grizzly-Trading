<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- FAVICONS / MANIFEST -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/web-app-manifest-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/web-app-manifest-512x512.png">

    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Futures Margin & Leverage Visualizer | Grizzly Parrot Trading</title>
    <meta name="description" content="See real futures leverage, margin usage, and dollar P/L for a move in price. Pick a contract, set account size and margin, and drag the slider.">
    <meta name="robots" content="index, follow">

    <!-- Canonical -->
    <link rel="canonical" href="https://grizzlyparrottrading.com/margin-leverage-visualizer.html">

    <!-- Open Graph -->
    <meta property="og:title" content="Futures Margin & Leverage Visualizer | Grizzly Parrot Trading">
    <meta property="og:description" content="Interactive futures margin and leverage tool with live P/L, leverage, and margin-usage charts.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://grizzlyparrottrading.com/margin-leverage-visualizer.html">
    <meta property="og:site_name" content="Grizzly Parrot Trading">
    <meta property="og:image" content="https://grizzlyparrottrading.com/og-default.png">
    <meta property="og:image:width" content="1792">
    <meta property="og:image:height" content="941">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://grizzlyparrottrading.com/og-default.png">
    <meta name="twitter:title" content="Futures Margin & Leverage Visualizer | Grizzly Parrot Trading">
    <meta name="twitter:description" content="Check real leverage, margin usage, and P/L per point on common futures contracts.">

    <!-- Google tag (Analytics) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JMJVR3G5YN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JMJVR3G5YN');
    </script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
<header class="site-header">
    <div class="container header-inner">
        <div class="logo">
            <span class="logo-mark">GP</span>
            <span class="logo-text">Grizzly Parrot Trading</span>
        </div>
        <nav class="main-nav">
            <a href="/app.html" id="get-app-link">Get the App</a>
            <a href="futures-basics/index.html">Futures Basics</a>
            <a href="prop-firm-trading/index.html">Prop Firms</a>
            <a href="platforms-tutorials/index.html">Platforms</a>
            <a href="market-basics/index.html">Market Basics</a>
        </nav>
    </div>
</header>

<main>
    <section class="hero">
        <div class="container hero-inner">
            <div class="hero-text">
                <h1>Futures Margin &amp; Leverage Visualizer</h1>
                <p>
                    Pick a contract, plug in your account size and margin, and drag the slider.  
                    See how much notional you are swinging, how much margin you are tying up, and what a move in price does to your P/L.
                </p>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <h2>Inputs</h2>

            <div class="tool-grid">
                <div class="tool-block">
                    <label for="ml-symbol">Contract</label>
                    <select id="ml-symbol">
                        <!-- Index futures -->
                        <option value="ES">ES (E-mini S&amp;P 500)</option>
                        <option value="MES">MES (Micro E-mini S&amp;P 500)</option>
                        <option value="NQ">NQ (E-mini Nasdaq-100)</option>
                        <option value="MNQ">MNQ (Micro E-mini Nasdaq-100)</option>
                        <option value="YM">YM (E-mini Dow)</option>
                        <option value="MYM">MYM (Micro E-mini Dow)</option>
                        <option value="RTY">RTY (E-mini Russell 2000)</option>
                        <option value="M2K">M2K (Micro E-mini Russell 2000)</option>

                        <!-- FX majors -->
                        <option value="6E">6E (Euro FX)</option>
                        <option value="6B">6B (British Pound)</option>
                        <option value="6J">6J (Japanese Yen)</option>
                        <option value="6A">6A (Australian Dollar)</option>
                        <option value="6C">6C (Canadian Dollar)</option>
                        <option value="6S">6S (Swiss Franc)</option>
                        <option value="6N">6N (New Zealand Dollar)</option>
                        <option value="6M">6M (Mexican Peso)</option>

                        <!-- Metals -->
                        <option value="GC">GC (Gold)</option>
                        <option value="MGC">MGC (Micro Gold)</option>
                        <option value="SI">SI (Silver)</option>
                        <option value="HG">HG (Copper)</option>
                        <option value="PL">PL (Platinum)</option>
                        <option value="PA">PA (Palladium)</option>

                        <!-- Energies -->
                        <option value="CL">CL (Crude Oil)</option>
                        <option value="MCL">MCL (Micro Crude Oil)</option>
                        <option value="QM">QM (E-mini Crude Oil)</option>
                        <option value="NG">NG (Natural Gas)</option>
                        <option value="QG">QG (E-mini Natural Gas)</option>
                        <option value="RB">RB (RBOB Gasoline)</option>
                        <option value="HO">HO (Heating Oil)</option>

                        <!-- Grains / oilseeds -->
                        <option value="ZC">ZC (Corn)</option>
                        <option value="ZS">ZS (Soybeans)</option>
                        <option value="ZW">ZW (Wheat)</option>
                        <option value="ZL">ZL (Soybean Oil)</option>
                        <option value="ZM">ZM (Soybean Meal)</option>
                        <option value="KE">KE (KC Wheat)</option>
                        <option value="O">O (Oats)</option>

                        <!-- Softs -->
                        <option value="KC">KC (Coffee)</option>
                        <option value="SB">SB (Sugar No. 11)</option>
                        <option value="CT">CT (Cotton)</option>
                        <option value="CC">CC (Cocoa)</option>
                        <option value="OJ">OJ (Orange Juice)</option>

                        <!-- Livestock -->
                        <option value="LE">LE (Live Cattle)</option>
                        <option value="HE">HE (Lean Hogs)</option>
                        <option value="GF">GF (Feeder Cattle)</option>

                        <!-- Rates -->
                        <option value="ZT">ZT (2-Year T-Note)</option>
                        <option value="ZF">ZF (5-Year T-Note)</option>
                        <option value="ZN">ZN (10-Year T-Note)</option>
                        <option value="ZB">ZB (30-Year T-Bond)</option>
                        <option value="UB">UB (Ultra T-Bond)</option>
                        <option value="SR3">SR3 (3-Month SOFR)</option>
                    </select>
                </div>

                <div class="tool-block">
                    <label for="ml-account">Account Size ($)</label>
                    <input type="number" id="ml-account" min="0" step="1" placeholder="e.g. 2500">
                </div>

                <div class="tool-block">
                    <label for="ml-price">Current Futures Price</label>
                    <input type="number" id="ml-price" min="0" step="0.0001" placeholder="e.g. 5300.00 or 1.1050 or 5.25">
                    <p class="field-help">
                        Enter price exactly how your platform shows it.<br>
                        Index / metals / energies: normal price (e.g. 5300.00, 78.25, 2450.4).<br>
                        FX (6E, 6B, etc.): decimal (e.g. 1.1050, 0.7500).<br>
                        Grains / softs: dollars per unit (e.g. 5.25 for ZC, 0.85 for ZL, 190.00 for KC).
                    </p>
                </div>

                <div class="tool-block">
                    <label for="ml-contracts">Contracts</label>
                    <input type="number" id="ml-contracts" min="1" step="1" placeholder="e.g. 1">
                </div>

                <div class="tool-block">
                    <label for="ml-margin-intra">Intraday Margin / Contract ($)</label>
                    <input type="number" id="ml-margin-intra" min="0" step="1" placeholder="e.g. 500">
                </div>

                <div class="tool-block">
                    <label for="ml-margin-overnight">Overnight Margin / Contract ($)</label>
                    <input type="number" id="ml-margin-overnight" min="0" step="1" placeholder="e.g. 13200">
                </div>

                <div class="tool-block">
                    <label>Margin Mode</label>
                    <div class="tool-inline">
                        <label><input type="radio" name="ml-margin-mode" value="intra" checked> Intraday</label>
                        <label><input type="radio" name="ml-margin-mode" value="overnight"> Overnight</label>
                    </div>
                </div>

                <div class="tool-block">
                    <label for="ml-move-points">Price Move (points)</label>
                    <div class="ml-slider-row">
                        <input type="range" id="ml-move-points" min="-50" max="50" step="0.25" value="5">
                        <input type="number" id="ml-move-points-number" step="0.25" value="5">
                    </div>
                    <p class="field-help">
                        Positive = move in your favor. Negative = move against you.<br>
                        This is in <strong>price units</strong>, not ticks.
                    </p>
                </div>

                <div class="tool-block">
                    <button id="ml-calc-btn" class="button-primary">Recalculate</button>
                </div>
            </div>
        </div>
    </section>

    <section class="section section-alt">
        <div class="container">
            <h2>Results</h2>
            <div id="ml-results-summary" class="results-box">
                <p>Fill out the inputs and move the slider.</p>
            </div>
            <div id="ml-results-detail" class="results-box" style="margin-top: 20px;">
                <!-- details injected here -->
            </div>

            <div class="results-chart-wrapper">
                <h3>Price Move vs P/L (Dollars)</h3>
                <canvas id="ml-chart-pl" width="700" height="260"></canvas>
                <p class="field-help">
                    Line = P/L across the slider range. Dot = your current slider move.
                </p>
            </div>

            <div class="results-chart-wrapper">
                <h3>Contracts vs Leverage (x)</h3>
                <canvas id="ml-chart-lev" width="700" height="260"></canvas>
                <p class="field-help">
                    How fast your leverage ramps as you size up, with your current position marked.
                </p>
            </div>

            <div class="results-chart-wrapper">
                <h3>Contracts vs Margin Usage (% of Account)</h3>
                <canvas id="ml-chart-margin" width="700" height="260"></canvas>
                <p class="field-help">
                    Margin used as a percentage of your account as you add contracts.
                </p>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <h2>How To Read This</h2>
            <div class="grid grid-3">
                <article class="card">
                    <h3>Notional &amp; Leverage</h3>
                    <p>
                        Notional = price × contract multiplier × contracts.  
                        Leverage = total notional ÷ your account.
                    </p>
                </article>
                <article class="card">
                    <h3>Margin Usage</h3>
                    <p>
                        Margin used = margin/contract × contracts.  
                        Margin % tells you how much of your account is locked just to hold the position.
                    </p>
                </article>
                <article class="card">
                    <h3>Sizing Reality Check</h3>
                    <p>
                        P/L chart shows the damage from price.  
                        Leverage and margin charts show how quickly you’re overexposed as you size up.
                    </p>
                </article>
            </div>
        </div>
    </section>
</main>

<footer class="site-footer">
    <div class="container footer-inner">
        <p>&copy; <span id="ml-year"></span> Grizzly Parrot Trading. All rights reserved.</p>
        <div class="footer-links">
            <a href="about.html">About</a>
            <a href="disclaimer.html">Disclaimer</a>
            <a href="privacy.html">Privacy</a>
            <a href="contact.html">Contact</a>
            <a href="https://grizzlyparrott.github.io/Probabilistic-Execution/" style="color:#22c55e;" target="_blank">
                Probabilistic Execution – Free 3-Phase Trading Routine
            </a>
        </div>
    </div>
    <script>
        document.getElementById("ml-year").textContent = new Date().getFullYear();
    </script>
</footer>

<script>
// Contract specs: dollarPerPoint = P/L for a 1.00 move in price.
// multiplier = contract size used for notional = price * multiplier.
const ML_CONTRACTS = {
  // INDEX FUTURES
  ES:  { name: "ES (E-mini S&P 500)",               dollarPerPoint: 50,       multiplier: 50 },
  MES: { name: "MES (Micro E-mini S&P 500)",        dollarPerPoint: 5,        multiplier: 5 },
  NQ:  { name: "NQ (E-mini Nasdaq-100)",            dollarPerPoint: 20,       multiplier: 20 },
  MNQ: { name: "MNQ (Micro E-mini Nasdaq-100)",     dollarPerPoint: 2,        multiplier: 2 },
  YM:  { name: "YM (E-mini Dow)",                   dollarPerPoint: 5,        multiplier: 5 },
  MYM: { name: "MYM (Micro E-mini Dow)",            dollarPerPoint: 0.5,      multiplier: 0.5 },
  RTY: { name: "RTY (E-mini Russell 2000)",         dollarPerPoint: 50,       multiplier: 50 },
  M2K: { name: "M2K (Micro E-mini Russell 2000)",   dollarPerPoint: 5,        multiplier: 5 },

  // FX MAJORS
  "6E": { name: "6E (Euro FX)",                     dollarPerPoint: 125000,   multiplier: 125000 },
  "6B": { name: "6B (British Pound)",               dollarPerPoint: 62500,    multiplier: 62500 },
  "6J": { name: "6J (Japanese Yen)",                dollarPerPoint: 12500000, multiplier: 12500000 },
  "6A": { name: "6A (Australian Dollar)",           dollarPerPoint: 100000,   multiplier: 100000 },
  "6C": { name: "6C (Canadian Dollar)",             dollarPerPoint: 100000,   multiplier: 100000 },
  "6S": { name: "6S (Swiss Franc)",                 dollarPerPoint: 125000,   multiplier: 125000 },
  "6N": { name: "6N (New Zealand Dollar)",          dollarPerPoint: 100000,   multiplier: 100000 },
  "6M": { name: "6M (Mexican Peso)",                dollarPerPoint: 500000,   multiplier: 500000 },

  // METALS
  GC:  { name: "GC (Gold)",                         dollarPerPoint: 100,      multiplier: 100 },
  MGC: { name: "MGC (Micro Gold)",                  dollarPerPoint: 10,       multiplier: 10 },
  SI:  { name: "SI (Silver)",                       dollarPerPoint: 5000,     multiplier: 5000 },
  HG:  { name: "HG (Copper)",                       dollarPerPoint: 25000,    multiplier: 25000 },
  PL:  { name: "PL (Platinum)",                     dollarPerPoint: 50,       multiplier: 50 },
  PA:  { name: "PA (Palladium)",                    dollarPerPoint: 100,      multiplier: 100 },

  // ENERGIES
  CL:  { name: "CL (Crude Oil)",                    dollarPerPoint: 1000,     multiplier: 1000 },
  MCL:{ name: "MCL (Micro Crude Oil)",              dollarPerPoint: 100,      multiplier: 100 },
  QM:  { name: "QM (E-mini Crude Oil)",             dollarPerPoint: 500,      multiplier: 500 },
  NG:  { name: "NG (Natural Gas)",                  dollarPerPoint: 10000,    multiplier: 10000 },
  QG:  { name: "QG (E-mini Natural Gas)",           dollarPerPoint: 2500,     multiplier: 2500 },
  RB:  { name: "RB (RBOB Gasoline)",                dollarPerPoint: 42000,    multiplier: 42000 },
  HO:  { name: "HO (Heating Oil)",                  dollarPerPoint: 42000,    multiplier: 42000 },

  // GRAINS / OILSEEDS
  ZC:  { name: "ZC (Corn)",                         dollarPerPoint: 5000,     multiplier: 5000 },
  ZS:  { name: "ZS (Soybeans)",                     dollarPerPoint: 5000,     multiplier: 5000 },
  ZW:  { name: "ZW (Wheat)",                        dollarPerPoint: 5000,     multiplier: 5000 },
  ZL:  { name: "ZL (Soybean Oil)",                  dollarPerPoint: 60000,    multiplier: 60000 },
  ZM:  { name: "ZM (Soybean Meal)",                 dollarPerPoint: 100,      multiplier: 100 },
  KE:  { name: "KE (KC Wheat)",                     dollarPerPoint: 5000,     multiplier: 5000 },
  O:   { name: "O (Oats)",                          dollarPerPoint: 5000,     multiplier: 5000 },

  // SOFTS
  KC:  { name: "KC (Coffee)",                       dollarPerPoint: 37500,    multiplier: 37500 },
  SB:  { name: "SB (Sugar No. 11)",                 dollarPerPoint: 112000,   multiplier: 112000 },
  CT:  { name: "CT (Cotton)",                       dollarPerPoint: 50000,    multiplier: 50000 },
  CC:  { name: "CC (Cocoa)",                        dollarPerPoint: 10,       multiplier: 10 },
  OJ:  { name: "OJ (Orange Juice)",                 dollarPerPoint: 15000,    multiplier: 15000 },

  // LIVESTOCK
  LE:  { name: "LE (Live Cattle)",                  dollarPerPoint: 40000,    multiplier: 40000 },
  HE:  { name: "HE (Lean Hogs)",                    dollarPerPoint: 40000,    multiplier: 40000 },
  GF:  { name: "GF (Feeder Cattle)",                dollarPerPoint: 50000,    multiplier: 50000 },

  // RATES
  ZT:  { name: "ZT (2-Year T-Note)",                dollarPerPoint: 2000,     multiplier: 2000 },
  ZF:  { name: "ZF (5-Year T-Note)",                dollarPerPoint: 1000,     multiplier: 1000 },
  ZN:  { name: "ZN (10-Year T-Note)",               dollarPerPoint: 1000,     multiplier: 1000 },
  ZB:  { name: "ZB (30-Year T-Bond)",               dollarPerPoint: 1000,     multiplier: 1000 },
  UB:  { name: "UB (Ultra T-Bond)",                 dollarPerPoint: 1000,     multiplier: 1000 },
  SR3:{ name: "SR3 (3-Month SOFR)",                 dollarPerPoint: 2500,     multiplier: 2500 }
};

function mlFmt(num, dec) {
  return Number(num).toFixed(dec);
}

const mlSymbolEl = document.getElementById("ml-symbol");
const mlAccountEl = document.getElementById("ml-account");
const mlPriceEl = document.getElementById("ml-price");
const mlContractsEl = document.getElementById("ml-contracts");
const mlMarginIntraEl = document.getElementById("ml-margin-intra");
const mlMarginOvernightEl = document.getElementById("ml-margin-overnight");
const mlMoveSliderEl = document.getElementById("ml-move-points");
const mlMoveNumberEl = document.getElementById("ml-move-points-number");
const mlCalcBtn = document.getElementById("ml-calc-btn");
const mlResultsSummary = document.getElementById("ml-results-summary");
const mlResultsDetail = document.getElementById("ml-results-detail");

const plCanvas = document.getElementById("ml-chart-pl");
const plCtx = plCanvas.getContext("2d");

const levCanvas = document.getElementById("ml-chart-lev");
const levCtx = levCanvas.getContext("2d");

const marginCanvas = document.getElementById("ml-chart-margin");
const marginCtx = marginCanvas.getContext("2d");

// generic chart for move vs something
function drawMoveChart(ctx, canvas, yLabelPrefix, computeYFromMove, minMove, maxMove, currentMove) {
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const testVals = [minMove, maxMove, 0, currentMove];
  const yVals = [];
  for (let i = 0; i < testVals.length; i++) {
    const y = computeYFromMove(testVals[i]);
    if (isFinite(y)) yVals.push(y);
  }

  if (!yVals.length) {
    ctx.fillStyle = "#666";
    ctx.font = "14px system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";
    ctx.fillText("Enter valid inputs to see the curve.", 20, h / 2);
    return;
  }

  let yMin = Math.min.apply(null, yVals);
  let yMax = Math.max.apply(null, yVals);
  if (yMin === yMax) {
    yMin -= 1;
    yMax += 1;
  }

  const paddingLeft = 60;
  const paddingRight = 20;
  const paddingTop = 20;
  const paddingBottom = 40;

  const xToPx = (move) => {
    const t = (move - minMove) / (maxMove - minMove || 1);
    return paddingLeft + t * (w - paddingLeft - paddingRight);
  };
  const yToPx = (y) => {
    const t = (y - yMin) / (yMax - yMin || 1);
    return h - paddingBottom - t * (h - paddingTop - paddingBottom);
  };

  ctx.fillStyle = "#f7f9fc";
  ctx.fillRect(0, 0, w, h);

  ctx.strokeStyle = "#ccc";
  ctx.lineWidth = 1;

  // x-axis at y=0 if in range
  if (yMin < 0 && yMax > 0) {
    const zeroY = yToPx(0);
    ctx.beginPath();
    ctx.moveTo(paddingLeft, zeroY);
    ctx.lineTo(w - paddingRight, zeroY);
    ctx.stroke();
  }

  // y-axis at move=0
  if (minMove < 0 && maxMove > 0) {
    const zeroX = xToPx(0);
    ctx.beginPath();
    ctx.moveTo(zeroX, paddingTop);
    ctx.lineTo(zeroX, h - paddingBottom);
    ctx.stroke();
  }

  ctx.fillStyle = "#555";
  ctx.font = "12px system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";

  ctx.fillText(minMove.toFixed(1), xToPx(minMove) - 10, h - paddingBottom + 16);
  ctx.fillText("0", xToPx(0) - 6, h - paddingBottom + 16);
  ctx.fillText(maxMove.toFixed(1), xToPx(maxMove) - 10, h - paddingBottom + 16);

  ctx.fillText(yLabelPrefix + mlFmt(yMax, 2), 10, yToPx(yMax) - 4);
  ctx.fillText(yLabelPrefix + mlFmt(yMin, 2), 10, yToPx(yMin) + 12);

  // line
  ctx.strokeStyle = "#0a3764";
  ctx.lineWidth = 2;
  const steps = 60;
  ctx.beginPath();
  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const move = minMove + t * (maxMove - minMove);
    const yVal = computeYFromMove(move);
    const xPx = xToPx(move);
    const yPx = yToPx(yVal);
    if (i === 0) ctx.moveTo(xPx, yPx);
    else ctx.lineTo(xPx, yPx);
  }
  ctx.stroke();

  // current point
  const currY = computeYFromMove(currentMove);
  const currX = xToPx(currentMove);
  const currYPx = yToPx(currY);

  ctx.fillStyle = currY >= (yMin + yMax) / 2 ? "#16a34a" : "#dc2626";
  ctx.beginPath();
  ctx.arc(currX, currYPx, 5, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#111";
  const label = `${currentMove.toFixed(2)} move → ${yLabelPrefix}${mlFmt(currY, 2)}`;
  ctx.fillText(label, Math.min(currX + 8, w - paddingRight - 160), currYPx - 8);
}

// chart for contracts vs something
function drawContractsChart(ctx, canvas, yLabelSuffix, computeYFromContracts, maxContracts, currentContracts) {
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  if (!isFinite(maxContracts) || maxContracts <= 0) {
    ctx.fillStyle = "#666";
    ctx.font = "14px system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";
    ctx.fillText("Enter margin and account size to see how size affects this.", 20, h / 2);
    return;
  }

  const xMin = 0;
  const xMax = maxContracts;

  const testVals = [xMin, xMax, currentContracts];
  const yVals = [];
  for (let i = 0; i < testVals.length; i++) {
    const y = computeYFromContracts(testVals[i]);
    if (isFinite(y)) yVals.push(y);
  }

  if (!yVals.length) {
    ctx.fillStyle = "#666";
    ctx.font = "14px system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";
    ctx.fillText("Enter valid inputs to see the curve.", 20, h / 2);
    return;
  }

  let yMin = Math.min.apply(null, yVals);
  let yMax = Math.max.apply(null, yVals);

  if (yMin === yMax) {
    yMin -= 1;
    yMax += 1;
  }

  const paddingLeft = 60;
  const paddingRight = 20;
  const paddingTop = 20;
  const paddingBottom = 40;

  const xToPx = (c) => {
    const t = (c - xMin) / (xMax - xMin || 1);
    return paddingLeft + t * (w - paddingLeft - paddingRight);
  };
  const yToPx = (y) => {
    const t = (y - yMin) / (yMax - yMin || 1);
    return h - paddingBottom - t * (h - paddingTop - paddingBottom);
  };

  ctx.fillStyle = "#f7f9fc";
  ctx.fillRect(0, 0, w, h);

  ctx.strokeStyle = "#ccc";
  ctx.lineWidth = 1;

  // y-axis at contracts=0
  const zeroX = xToPx(0);
  ctx.beginPath();
  ctx.moveTo(zeroX, paddingTop);
  ctx.lineTo(zeroX, h - paddingBottom);
  ctx.stroke();

  // x-axis at y=0 if in range
  if (yMin < 0 && yMax > 0) {
    const zeroY = yToPx(0);
    ctx.beginPath();
    ctx.moveTo(paddingLeft, zeroY);
    ctx.lineTo(w - paddingRight, zeroY);
    ctx.stroke();
  }

  ctx.fillStyle = "#555";
  ctx.font = "12px system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif";

  ctx.fillText("0", xToPx(0) - 4, h - paddingBottom + 16);
  ctx.fillText(xMax.toString(), xToPx(xMax) - 8, h - paddingBottom + 16);

  ctx.fillText(mlFmt(yMax, 2) + yLabelSuffix, 10, yToPx(yMax) - 4);
  ctx.fillText(mlFmt(yMin, 2) + yLabelSuffix, 10, yToPx(yMin) + 12);

  // line
  ctx.strokeStyle = "#0a3764";
  ctx.lineWidth = 2;
  const steps = Math.max(5, Math.min(40, xMax * 2));
  ctx.beginPath();
  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const c = xMin + t * (xMax - xMin);
    const yVal = computeYFromContracts(c);
    const xPx = xToPx(c);
    const yPx = yToPx(yVal);
    if (i === 0) ctx.moveTo(xPx, yPx);
    else ctx.lineTo(xPx, yPx);
  }
  ctx.stroke();

  // current point
  const currC = Math.min(Math.max(currentContracts, xMin), xMax);
  const currY = computeYFromContracts(currC);
  const currX = xToPx(currC);
  const currYPx = yToPx(currY);

  ctx.fillStyle = "#16a34a";
  ctx.beginPath();
  ctx.arc(currX, currYPx, 5, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#111";
  const label = `${mlFmt(currC, 2)} contracts → ${mlFmt(currY, 2)}${yLabelSuffix}`;
  ctx.fillText(label, Math.min(currX + 8, w - paddingRight - 180), currYPx - 8);
}

function mlCompute() {
  const symbol = mlSymbolEl.value;
  const spec = ML_CONTRACTS[symbol];

  const account = parseFloat(mlAccountEl.value);
  const price = parseFloat(mlPriceEl.value);
  const contracts = parseFloat(mlContractsEl.value);
  const marginIntra = parseFloat(mlMarginIntraEl.value);
  const marginOvernight = parseFloat(mlMarginOvernightEl.value);
  const movePoints = parseFloat(mlMoveSliderEl.value);
  const marginMode = document.querySelector('input[name="ml-margin-mode"]:checked').value;

  if (!spec) {
    mlResultsSummary.innerHTML = "<p>Unknown contract spec.</p>";
    mlResultsDetail.innerHTML = "";
    drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
    drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
    drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
    return;
  }

  if (isNaN(account) || account <= 0) {
    mlResultsSummary.innerHTML = "<p>Enter a valid account size.</p>";
    mlResultsDetail.innerHTML = "";
    drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
    drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
    drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
    return;
  }

  if (isNaN(price) || price <= 0) {
    mlResultsSummary.innerHTML = "<p>Enter a valid current futures price.</p>";
    mlResultsDetail.innerHTML = "";
    drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
    drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
    drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
    return;
  }

  if (isNaN(contracts) || contracts <= 0) {
    mlResultsSummary.innerHTML = "<p>Enter a valid number of contracts.</p>";
    mlResultsDetail.innerHTML = "";
    drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
    drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
    drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
    return;
  }

  let marginPer;
  if (marginMode === "intra") {
    if (isNaN(marginIntra) || marginIntra <= 0) {
      mlResultsSummary.innerHTML = "<p>Enter intraday margin per contract or switch to overnight.</p>";
      mlResultsDetail.innerHTML = "";
      drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
      drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
      drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
      return;
    }
    marginPer = marginIntra;
  } else {
    if (isNaN(marginOvernight) || marginOvernight <= 0) {
      mlResultsSummary.innerHTML = "<p>Enter overnight margin per contract or switch to intraday.</p>";
      mlResultsDetail.innerHTML = "";
      drawMoveChart(plCtx, plCanvas, "$", () => 0, -1, 1, 0);
      drawContractsChart(levCtx, levCanvas, "x", () => 0, 0, 0);
      drawContractsChart(marginCtx, marginCanvas, "%", () => 0, 0, 0);
      return;
    }
    marginPer = marginOvernight;
  }

  const dollarPerPoint = spec.dollarPerPoint;
  const multiplier = spec.multiplier;

  const notionalPer = price * multiplier;
  const totalNotional = notionalPer * contracts;
  const leverage = totalNotional / account;

  const marginUsed = marginPer * contracts;
  const marginPct = (marginUsed / account) * 100;

  const plPerPointTotal = dollarPerPoint * contracts;
  const movePL = movePoints * plPerPointTotal;
  const movePLPct = (movePL / account) * 100;
  const equityAfterMove = account + movePL;

  mlResultsSummary.innerHTML = `
    <p>
      <strong>${spec.name}</strong> | ${contracts} contract(s) on a $${mlFmt(account, 0)} account at price ${mlFmt(price, 4)}.
    </p>
    <p>
      Total notional: <strong>$${mlFmt(totalNotional, 2)}</strong>
      &nbsp;|&nbsp; Leverage: <strong>${mlFmt(leverage, 1)}x</strong>
      &nbsp;|&nbsp; Margin used: <strong>$${mlFmt(marginUsed, 0)}</strong> (${mlFmt(marginPct, 1)}% of account)
    </p>
  `;

  mlResultsDetail.innerHTML = `
    <div class="results-grid">
      <div class="results-item">
        <h3>Contract Specs</h3>
        <p><strong>Dollar per 1.00 move in price:</strong> $${mlFmt(dollarPerPoint, 2)} per contract</p>
        <p><strong>Notional per contract:</strong> $${mlFmt(notionalPer, 2)}</p>
        <p><strong>Total notional:</strong> $${mlFmt(totalNotional, 2)}</p>
      </div>
      <div class="results-item">
        <h3>Margin Profile (${marginMode === "intra" ? "Intraday" : "Overnight"})</h3>
        <p><strong>Margin per contract:</strong> $${mlFmt(marginPer, 0)}</p>
        <p><strong>Total margin used:</strong> $${mlFmt(marginUsed, 0)}</p>
        <p><strong>Margin usage:</strong> ${mlFmt(marginPct, 1)}% of account</p>
      </div>
      <div class="results-item">
        <h3>P/L From Price Moves</h3>
        <p><strong>1.00 move in price:</strong> $${mlFmt(plPerPointTotal, 2)} (${mlFmt((plPerPointTotal / account) * 100, 2)}% of account)</p>
        <p><strong>${mlFmt(movePoints, 2)} move in price:</strong> $${mlFmt(movePL, 2)} (${mlFmt(movePLPct, 2)}% of account)</p>
        <p><strong>Equity after this move:</strong> $${mlFmt(equityAfterMove, 2)}</p>
      </div>
    </div>
  `;

  const sliderMin = parseFloat(mlMoveSliderEl.min);
  const sliderMax = parseFloat(mlMoveSliderEl.max);

  // Chart 1: Price move vs dollar P/L
  drawMoveChart(
    plCtx,
    plCanvas,
    "$",
    function(move) { return move * plPerPointTotal; },
    sliderMin,
    sliderMax,
    movePoints
  );

  // max contracts for charts 2 and 3
  let maxContracts;
  if (marginPer > 0) {
    const caps = [];
    caps.push(account / marginPer * 2);  // "double" what your margin allows
    caps.push(20);                       // minimum decent range
    caps.push(1);                        // avoid zero
    maxContracts = Math.max(5, Math.min(50, Math.floor(Math.max.apply(null, caps))));
  } else {
    maxContracts = 20;
  }

  // Chart 2: contracts vs leverage
  drawContractsChart(
    levCtx,
    levCanvas,
    "x",
    function(c) {
      if (c <= 0) return 0;
      const notional = price * multiplier * c;
      return notional / account;
    },
    maxContracts,
    contracts
  );

  // Chart 3: contracts vs margin usage %
  drawContractsChart(
    marginCtx,
    marginCanvas,
    "%",
    function(c) {
      if (c <= 0) return 0;
      const mUsed = marginPer * c;
      return (mUsed / account) * 100;
    },
    maxContracts,
    contracts
  );
}

// sync slider + live compute
mlMoveSliderEl.addEventListener("input", function () {
  mlMoveNumberEl.value = mlMoveSliderEl.value;
  mlCompute();
});

mlMoveNumberEl.addEventListener("input", function () {
  const v = parseFloat(mlMoveNumberEl.value);
  if (!isNaN(v) &&
      v >= parseFloat(mlMoveSliderEl.min) &&
      v <= parseFloat(mlMoveSliderEl.max)) {
    mlMoveSliderEl.value = v;
    mlCompute();
  }
});

// button = recompute
mlCalcBtn.addEventListener("click", mlCompute);

// recompute when key inputs change
["change", "blur"].forEach(function(evt) {
  mlSymbolEl.addEventListener(evt, mlCompute);
  mlAccountEl.addEventListener(evt, mlCompute);
  mlPriceEl.addEventListener(evt, mlCompute);
  mlContractsEl.addEventListener(evt, mlCompute);
  mlMarginIntraEl.addEventListener(evt, mlCompute);
  mlMarginOvernightEl.addEventListener(evt, mlCompute);
});
document.querySelectorAll('input[name="ml-margin-mode"]').forEach(function(r) {
  r.addEventListener("change", mlCompute);
});

// initial empty charts
drawMoveChart(plCtx, plCanvas, "$", function(){ return 0; }, -1, 1, 0);
drawContractsChart(levCtx, levCanvas, "x", function(){ return 0; }, 0, 0);
drawContractsChart(marginCtx, marginCanvas, "%", function(){ return 0; }, 0, 0);
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("/sw.js").catch(function () {});
  });
}
</script>

<style>
.ml-slider-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.ml-slider-row input[type="range"] {
  flex: 1;
}
.ml-slider-row input[type="number"] {
  width: 90px;
}
.results-chart-wrapper {
  margin-top: 24px;
  padding: 16px;
  background: #f5f7fb;
  border-radius: 8px;
  border: 1px solid #dde3f0;
}
.results-chart-wrapper h3 {
  margin-top: 0;
  margin-bottom: 8px;
}
</style>

</body>
</html>
